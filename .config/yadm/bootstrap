#!/bin/sh
set -e

echo "Starting Setup (NixOS 25.11 - Flakes)..."

# Remove all user channels (we use flakes now)
if [ -n "$(nix-channel --list)" ]; then
	echo "Removing legacy channels..."
	nix-channel --list | cut -d' ' -f1 | while read -r channel; do
		nix-channel --remove "$channel"
	done
fi

# Ensure nix.conf with flakes is in place
if [ ! -f "$HOME/.config/nix/nix.conf" ]; then
	mkdir -p "$HOME/.config/nix"
	echo "experimental-features = nix-command flakes" > "$HOME/.config/nix/nix.conf"
fi

echo "Applying Home Manager configuration..."
nix run home-manager/release-25.11 -- switch --flake "$HOME/.config/home-manager#root"

echo "Configuring yadm remote..."
yadm remote set-url origin git@github.com:radutomy/dotnix.git

echo "Done!"
