#!/bin/bash

update_system() {
	apt update && apt upgrade -y
	export GPG_TTY=$(tty)

	# Update wezterm config - try both Windows (WSL) and macOS (OrbStack) paths
	cp ~/.config/wezterm/wezterm.lua /mnt/c/Users/$(cmd.exe /c "echo %USERNAME%" 2>/dev/null | tr -d '\r')/.config/wezterm/wezterm.lua 2>/dev/null || true

	MAC_USER=$(ls /mnt/mac/Users 2>/dev/null | grep -v Shared | head -n 1)
	if [ -n "$MAC_USER" ]; then
		mkdir -p /mnt/mac/Users/$MAC_USER/.config/wezterm 2>/dev/null || true
		cp ~/.config/wezterm/wezterm.lua /mnt/mac/Users/$MAC_USER/.config/wezterm/wezterm.lua 2>/dev/null || true
	fi
}

update_yadm() {
	yadm remote set-url origin git@github.com:radutomy/dotfiles.git
}

install_packages() {
	apt remove vim* snap* -y
	apt install wget curl yadm lsb-release libfuse2t64 bash-completion apt-transport-https net-tools jq tree zip \
		build-essential mingw-w64 lld cmake git git-delta tmux expect lsof sshpass unzip expect just zoxide sqlite3 \
		dnsutils software-properties-common python3-venv python-is-python3 python3-pip -y
}

repos() {
	cd ~ || exit
	git clone --branch main git@github.com:radutomy/rustlings.git && cd rustlings
	git config --local user.email "radu@rtom.dev" && cd ~

	git clone --branch main git@github.com:radutomy/nav-key.git && cd nav-key
	git config --local user.email "radu@rtom.dev" && cd ~
}

install_work() {
	cd ~ || exit

	apt install gcc-multilib google-android-cmdline-tools-13.0-installer gcc-x86-64-linux-gnu \
		g++-x86-64-linux-gnu default-jdk libglib2.0-dev libgtk-3-dev -y

	git config --global gpg.format ssh
	git config --global user.signingkey ~/.ssh/id_ed25519
	git config --global tag.gpgsign true
	git config --global commit.gpgsign true

	git clone --branch main git@gitlab.protontech.ch:proton/clients/monorepo.git && cd monorepo
	git config --local user.email "radu.tomuleasa@external.proton.ch" && cd ~

	git clone --branch develop git@gitlab.protontech.ch:chat/chat-client.git && cd chat-client
	git config --local user.email "radu.tomuleasa@external.proton.ch" && cd ~

	git clone --branch master git@gitlab.protontech.ch:rust/proton-rust.git && cd proton-rust
	git config --local user.email "radu.tomuleasa@external.proton.ch" && cd ~

	sed -i '/dhcp-identifier: mac/a\      accept-ra: false\n      link-local: []' /etc/netplan/10-lxc.yaml && netplan apply

	curl -fsSL https://get.pnpm.io/install.sh | sh -
	cargo install wasm-pack cargo-insta
    rustup target add aarch64-apple-darwin

	# cargo install wasm-bindgen-cli --version 0.2.106 --force
	# cargo install --locked dprint


	cd ~/chat-client || exit
	wasm-pack build core/persistence --target web --dev || exit
	wasm-pack build core/core-logic/shared --target web --dev --features web || exit

	cd ~
}

install_rust() {
	apt install libssl-dev libudev-dev pkg-config build-essential gdb clang -y
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --no-modify-path -y
	source "$HOME/.cargo/env"
	rustup component add rust-analyzer

	$HOME/.cargo/bin/cargo install cargo-binstall

	rustup target add aarch64-unknown-linux-musl
	rustup target add x86_64-unknown-linux-gnu
	rustup target add wasm32-unknown-unknown
	rustup target add x86_64-pc-windows-gnu
}

install_neovim() {
	curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
	apt install libreadline-dev ripgrep nodejs -y

	# Detect architecture
	ARCH=$(uname -m); [[ $ARCH == aarch64 || $ARCH == arm64 ]] && ARCH=arm64 || ARCH=x86_64

	curl -L "https://github.com/neovim/neovim/releases/download/stable/nvim-linux-${ARCH}.appimage" -o /bin/nvim
	chmod +x /bin/nvim
	nvim --headless "+Lazy! sync" +qa

	# Install LazyGit (with version) and LazySQL (without version)
	VER=$(curl -s https://api.github.com/repos/jesseduffield/lazygit/releases/latest|grep -Po '"tag_name": "v\K[^"]*')
	curl -L "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${VER}_Linux_${ARCH}.tar.gz" | tar xz lazygit
	curl -L "https://github.com/jorgerojas26/lazysql/releases/latest/download/lazysql_Linux_${ARCH}.tar.gz" | tar xz lazysql
	install lazy{git,sql} /usr/local/bin && rm lazy{git,sql}
}

install_docker() {
	apt install docker.io docker-buildx docker-compose-v2 -y
}

install_dioxus() {
	apt install libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev -y
	cargo install dioxus-cli
}

install_fish() {
	apt-add-repository ppa:fish-shell/release-4 -y
	apt install fish fzf fd-find bat lsd -y
	curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh 		# Install zoxide
	ln -s /usr/bin/batcat /usr/local/bin/bat			# https://github.com/sharkdp/bat/issues/982
	fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher update"
	chsh -s $(which fish)
}

install_gpt() {
	# npm install -g @google/gemini-cli
	curl -fsSL https://claude.ai/install.sh | bash
}

cleanup() {
	cd ~
	rm .motd_shown
}

update_system
update_yadm
install_packages
repos
install_rust

if [ "$runtime" = "work" ]; then
	install_work
fi

install_neovim
install_docker
#install_dioxus
install_gpt
install_fish
cleanup
